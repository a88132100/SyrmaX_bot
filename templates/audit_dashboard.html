<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyrmaX ç¨½æ ¸å„€è¡¨æ¿</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .events-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .status-passed {
            color: #28a745;
            font-weight: bold;
        }
        .status-rejected {
            color: #dc3545;
            font-weight: bold;
        }
        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” SyrmaX ç¨½æ ¸å„€è¡¨æ¿</h1>
            <p>å¯¦æ™‚ç›£æ§äº¤æ˜“ç¨½æ ¸å’Œé¢¨æ§ç‹€æ…‹</p>
        </div>
        
        <button class="refresh-btn" onclick="refreshDashboard()">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-events">-</div>
                <div class="stat-label">ç¸½äº‹ä»¶æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="signal-events">-</div>
                <div class="stat-label">ä¿¡è™Ÿäº‹ä»¶</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="risk-events">-</div>
                <div class="stat-label">é¢¨æ§äº‹ä»¶</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="order-events">-</div>
                <div class="stat-label">è¨‚å–®äº‹ä»¶</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3>é¢¨æ§åˆ†æ</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="risk-pass-rate">-</div>
                    <div class="stat-label">é¢¨æ§é€šéç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="order-fill-rate">-</div>
                    <div class="stat-label">è¨‚å–®æˆäº¤ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="risk-passed">-</div>
                    <div class="stat-label">é¢¨æ§é€šé</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="risk-rejected">-</div>
                    <div class="stat-label">é¢¨æ§æ‹’çµ•</div>
                </div>
            </div>
        </div>
        
        <div class="events-table">
            <h3 style="padding: 20px 20px 0 20px; margin: 0;">æœ€è¿‘äº‹ä»¶</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>äº‹ä»¶é¡å‹</th>
                        <th>äº¤æ˜“å°</th>
                        <th>ç‹€æ…‹</th>
                        <th>è©³æƒ…</th>
                    </tr>
                </thead>
                <tbody id="events-table-body">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function refreshDashboard() {
            fetch('/api/audit/dashboard/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateDashboard(data.dashboard);
                    } else {
                        console.error('ç²å–å„€è¡¨æ¿æ•¸æ“šå¤±æ•—:', data.error);
                    }
                })
                .catch(error => {
                    console.error('è«‹æ±‚å¤±æ•—:', error);
                });
        }
        
        function updateDashboard(dashboard) {
            // æ›´æ–°çµ±è¨ˆæ•¸å­—
            document.getElementById('total-events').textContent = dashboard.summary.total_events;
            document.getElementById('signal-events').textContent = dashboard.summary.signal_events;
            document.getElementById('risk-events').textContent = dashboard.summary.risk_events;
            document.getElementById('order-events').textContent = dashboard.summary.order_events;
            
            // æ›´æ–°é¢¨æ§åˆ†æ
            document.getElementById('risk-pass-rate').textContent = dashboard.risk_analysis.pass_rate.toFixed(1) + '%';
            document.getElementById('order-fill-rate').textContent = dashboard.order_analysis.fill_rate.toFixed(1) + '%';
            document.getElementById('risk-passed').textContent = dashboard.risk_analysis.passed;
            document.getElementById('risk-rejected').textContent = dashboard.risk_analysis.rejected;
            
            // æ›´æ–°äº‹ä»¶è¡¨æ ¼
            updateEventsTable(dashboard.recent_events);
        }
        
        function updateEventsTable(events) {
            const tbody = document.getElementById('events-table-body');
            tbody.innerHTML = '';
            
            if (events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">æš«ç„¡äº‹ä»¶</td></tr>';
                return;
            }
            
            events.forEach(event => {
                const row = document.createElement('tr');
                
                const time = new Date(event.timestamp).toLocaleString('zh-TW');
                const eventType = getEventTypeLabel(event.event_type);
                const symbol = event.symbol || '-';
                const status = getStatusLabel(event);
                const details = getEventDetails(event);
                
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${eventType}</td>
                    <td>${symbol}</td>
                    <td class="${getStatusClass(event)}">${status}</td>
                    <td>${details}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function getEventTypeLabel(eventType) {
            const labels = {
                'signal_generated': 'ä¿¡è™Ÿç”Ÿæˆ',
                'risk_checked': 'é¢¨æ§æª¢æŸ¥',
                'explain_created': 'è§£é‡‹ç”Ÿæˆ',
                'order_submitted': 'è¨‚å–®æäº¤',
                'order_filled': 'è¨‚å–®æˆäº¤',
                'order_rejected': 'è¨‚å–®æ‹’çµ•'
            };
            return labels[eventType] || eventType;
        }
        
        function getStatusLabel(event) {
            if (event.passed !== undefined) {
                return event.passed ? 'é€šé' : 'æ‹’çµ•';
            }
            if (event.side) {
                return event.side === 'long' ? 'åšå¤š' : event.side === 'short' ? 'åšç©º' : 'è§€æœ›';
            }
            return 'è™•ç†ä¸­';
        }
        
        function getStatusClass(event) {
            if (event.passed !== undefined) {
                return event.passed ? 'status-passed' : 'status-rejected';
            }
            return 'status-pending';
        }
        
        function getEventDetails(event) {
            if (event.confidence) {
                return `ä¿¡å¿ƒåº¦: ${(event.confidence * 100).toFixed(1)}%`;
            }
            if (event.risk_level) {
                return `é¢¨éšªç­‰ç´š: ${event.risk_level}`;
            }
            if (event.quantity) {
                return `æ•¸é‡: ${event.quantity}`;
            }
            return '-';
        }
        
        // é é¢è¼‰å…¥æ™‚åˆ·æ–°æ•¸æ“š
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            // æ¯30ç§’è‡ªå‹•åˆ·æ–°
            setInterval(refreshDashboard, 30000);
        });
    </script>
</body>
</html>
